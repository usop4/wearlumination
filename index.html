<html>
<head>
    <meta charset="UTF-8">
    <link href="static/bootstrap.min.css" rel="stylesheet" type="text/css" />
</head>
<body>

<div class="container">

    <div class="row">
        <div class="col-md-3 center-block">
            <canvas id="pieChart"></canvas>
            <p>smile:<span id="smileLevel"></span></p>
            <p>trouble:<span id="troubleLevel"></span></p>
            <p>age:<span id="ageResult"></span></p>
            <p>doya:<span id="doyaLevel"></span></p>
            <p>animal:<span id="similarAnimal"></span></p>
        </div>
        <div class="col-md-6">
            <canvas id="canvas" width="512" height="384"></canvas>
            <video id='video' width="512" height="384"></video>
        </div>
        <div class="col-md-3">

            <iframe src="sensor" width="300" height="100"></iframe>

        </div>
    </div>

    <div class="row">
        <div class="col-md-12">.</div>
    </div>

    <div class="row">
        <div class="col-md-1"></div>
        <div class="col-md-10 center-block">
            <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">

                <div class="carousel-inner" role="listbox">
                    <div class="item active"><img src="img/img.001.jpg"></div>
                    <div class="item"><img src="img/img.002.jpg"></div>
                    <div class="item"><img src="img/img.003.jpg"></div>
                    <div class="item"><img src="img/img.004.jpg"></div>
                    <div class="item"><img src="img/img.005.jpg"></div>
                </div>

            </div>
        </div>
        <div class="col-md-1"></div>
    </div>

    <iframe id="iframe" src="" width="1" height="1"></iframe>

</div>

<script src="static/jQuery-2.1.4.min.js"></script>
<script src="static/bootstrap.min.js" type="text/javascript"></script>
<script src="static/Chart.min.js" type="text/javascript"></script>
<script>
    var GUM = {};
    var toggle = "play";

    var initSmile = 50;
    var initTrouble = 50;

    $(document).ready(function() {

        var pieChartCanvas = $("#pieChart").get(0).getContext("2d");
        var pieChart = new Chart(pieChartCanvas);
        var PieData = [
            {
                value: 0,
                color:"#F7464A",
                highlight: "#FF5A5E",
                label: "joyful"
            },
            {
                value: 100,
                color: "#888098",
                highlight: "#888098",
                label: "gray"
            },
            {
                value: 0,
                color: "#46BFBD",
                highlight: "#5AD3D1",
                label: "trouble"
            }
        ];

        var pieOptions = {
            segmentStrokeColor: "#fff",
            segmentStrokeWidth: 2,
            percentageInnerCutout: 50, // This is 0 for Pie charts
            animationSteps: 100,
            animationEasing: "easeOutBounce",
            //animationEasing: "easeOutCubic",
            animateRotate: false,
            animateScale: false,
            responsive: false,
            maintainAspectRatio: false
            //legendTemplate: "<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<segments.length; i++){%><li><span style=\"background-color:<%=segments[i].fillColor%>\"></span><%if(segments[i].label){%><%=segments[i].label%><%}%></li><%}%></ul>"
        };
        pieChart.Doughnut(PieData, pieOptions);

        playVoice = function(text){
            url = "http://barcelona.sakura.ne.jp/sandbox/wearlumination/api.php?mode=tts&text="+text
            console.log("playVoice:"+text);
            $("#iframe").attr("src",url);
        }

        //playVoice("スペースキーを押してください");

        GUM.initCamera = function() {
            navigator.webkitGetUserMedia({
                    video : true
                },
                function(localMediaStream) {
                    GUM.video.src = window.URL.createObjectURL(localMediaStream);
                    GUM.video.play();

                    video.style.cssText += "transform: rotateY(180deg);-webkit-transform:rotateY(180deg);-moz-transform:rotateY(180deg);-ms-transform:rotateY(180deg);";

                }, function(err) {
                    console.log(err);
                }
            );



        };

        GUM.shutter = function() {
            var context2d = GUM.canvas.getContext('2d');
            var url = 'http://barcelona.sakura.ne.jp/sandbox/wearlumination/api.php?mode=pux'

            context2d.drawImage(GUM.video, 0, 0, 512, 384);

            try {
                var imgData = GUM.canvas.toDataURL("image/jpeg");
                $.ajax({
                    url: url,
                    type: 'POST',
                    contentType: 'application/x-www-form-urlencoded',
                    data : imgData,
                    dataType : "json"
                }).done(function(data){
                    //console.log(data);
                    console.log(data["results"]);
                    if( "" == data["results"]["faceRecognition"]["errorInfo"]){

                        faceInfo = data["results"]["faceRecognition"]["detectionFaceInfo"][0];

                        smileLevel = faceInfo["smileJudge"]["smileLevel"];
                        troubleLevel = faceInfo["enjoyJudge"]["troubleLevel"];

                        ageResult = faceInfo["ageJudge"]["ageResult"];
                        $('#ageResult').text(ageResult);

                        doyaLevel = faceInfo["enjoyJudge"]["doyaLevel"];
                        $('#doyaLevel').text(doyaLevel);

                        similarAnimal = faceInfo["enjoyJudge"]["similarAnimal"];
                        $('#similarAnimal').text(similarAnimal);

                    }else{
                        playVoice("認識できませんでした");
                        smileLevel = 0
                        troubleLevel = 0
                    }

                    $('#smileLevel').text(smileLevel);
                    $('#troubleLevel').text(troubleLevel);

                    PieData[0]["value"] = smileLevel;
                    PieData[1]["value"] = 100 - smileLevel - troubleLevel;
                    PieData[2]["value"] = troubleLevel;

                    s = "http://localhost:8946/command/r"+parseInt(smileLevel/10);
                    $.get(s);
                    s = "http://localhost:8946/command/g"+parseInt(troubleLevel/10);
                    $.get(s);

                    pieChart.Doughnut(PieData, pieOptions);

                }).fail(function(data){
                    console.log("fail");
                    console.log(data);
                });
            } catch (e) {
                console.log(e.message);
            }
        };

        document.onkeydown = function(e){

            if(e.keyCode == 32){    // space
                GUM.shutter();
            }

            if(e.keyCode == 48){    // 0
                $.ajax({
                    url: "http://localhost:8946/command/r0"
                }).success(function(res){
                    console.log(res);
                })
                $.ajax({
                    url: "http://localhost:8946/command/r0"
                }).success(function(res){
                    console.log(res);
                })
            }

        }

        GUM.canvas = $('#canvas').hide()[0];
        GUM.video = $('#video')[0];
        GUM.initCamera();

    });

</script>

</body>
</html>
